// CodeMirror, copyright (c) by Marijn Haverbeke and others
!function(e){"object"==typeof exports&&"object"==typeof module?e(require("../../lib/codemirror")):"function"==typeof define&&define.amd?define(["../../lib/codemirror"],e):e(CodeMirror)}(function(e){"use strict";function n(e){var n=e.search(l);return-1==n?0:n}function t(e,n,t){return/\bstring\b/.test(e.getTokenTypeAt(o(n.line,0)))&&!/^[\'\"`]/.test(t)}var i={},l=/[^\s\u00a0]/,o=e.Pos;e.commands.toggleComment=function(e){e.toggleComment()},e.defineExtension("toggleComment",function(e){e||(e=i);for(var n=this,t=Infinity,l=this.listSelections(),r=null,a=l.length-1;a>=0;a--){var m=l[a].from(),c=l[a].to();m.line>=t||(c.line>=t&&(c=o(t,0)),t=m.line,null==r?n.uncomment(m,c,e)?r="un":(n.lineComment(m,c,e),r="line"):"un"==r?n.uncomment(m,c,e):n.lineComment(m,c,e))}}),e.defineExtension("lineComment",function(e,r,a){a||(a=i);var m=this,c=m.getModeAt(e),f=m.getLine(e.line);if(null!=f&&!t(m,e,f)){var g=a.lineComment||c.lineComment;if(g){var s=Math.min(0!=r.ch||r.line==e.line?r.line+1:r.line,m.lastLine()+1),d=null==a.padding?" ":a.padding,u=a.commentBlankLines||e.line==r.line;m.operation(function(){if(a.indent){for(var t=null,i=e.line;i<s;++i){var r=(c=m.getLine(i)).slice(0,n(c));(null==t||t.length>r.length)&&(t=r)}for(i=e.line;i<s;++i){var c=m.getLine(i),f=t.length;(u||l.test(c))&&(c.slice(0,f)!=t&&(f=n(c)),m.replaceRange(t+g+d,o(i,0),o(i,f)))}}else for(i=e.line;i<s;++i)(u||l.test(m.getLine(i)))&&m.replaceRange(g+d,o(i,0))})}else(a.blockCommentStart||c.blockCommentStart)&&(a.fullLines=!0,m.blockComment(e,r,a))}}),e.defineExtension("blockComment",function(e,n,t){t||(t=i);var r=this,a=r.getModeAt(e),m=t.blockCommentStart||a.blockCommentStart,c=t.blockCommentEnd||a.blockCommentEnd;if(m&&c){var f=Math.min(n.line,r.lastLine());f!=e.line&&0==n.ch&&l.test(r.getLine(f))&&--f;var g=null==t.padding?" ":t.padding;e.line>f||r.operation(function(){if(0!=t.fullLines){var i=l.test(r.getLine(f));r.replaceRange(g+c,o(f)),r.replaceRange(m+g,o(e.line,0));var s=t.blockCommentLead||a.blockCommentLead;if(null!=s)for(var d=e.line+1;d<=f;++d)(d!=f||i)&&r.replaceRange(s+g,o(d,0))}else r.replaceRange(c,n),r.replaceRange(m,e)})}else(t.lineComment||a.lineComment)&&0!=t.fullLines&&r.lineComment(e,n,t)}),e.defineExtension("uncomment",function(e,n,t){t||(t=i);var r,a=this,m=a.getModeAt(e),c=Math.min(0!=n.ch||n.line==e.line?n.line:n.line-1,a.lastLine()),f=Math.min(e.line,c),g=t.lineComment||m.lineComment,s=[],d=null==t.padding?" ":t.padding;e:if(g){for(var u=f;u<=c;++u){var h=a.getLine(u),p=h.indexOf(g);if(p>-1&&!/comment/.test(a.getTokenTypeAt(o(u,p+1)))&&(p=-1),-1==p&&(u!=c||u==f)&&l.test(h))break e;if(p>-1&&l.test(h.slice(0,p)))break e;s.push(h)}if(a.operation(function(){for(var e=f;e<=c;++e){var n=s[e-f],t=n.indexOf(g),i=t+g.length;t<0||(n.slice(i,i+d.length)==d&&(i+=d.length),r=!0,a.replaceRange("",o(e,t),o(e,i)))}}),r)return!0}var C=t.blockCommentStart||m.blockCommentStart,v=t.blockCommentEnd||m.blockCommentEnd;if(!C||!v)return!1;var b=t.blockCommentLead||m.blockCommentLead,k=a.getLine(f),L=c==f?k:a.getLine(c),x=k.indexOf(C),R=L.lastIndexOf(v);if(-1==R&&f!=c&&(L=a.getLine(--c),R=L.lastIndexOf(v)),-1==x||-1==R||!/comment/.test(a.getTokenTypeAt(o(f,x+1)))||!/comment/.test(a.getTokenTypeAt(o(c,R+1))))return!1;var O=k.lastIndexOf(C,e.ch),y=-1==O?-1:k.slice(0,e.ch).indexOf(v,O+C.length);if(-1!=O&&-1!=y&&y+v.length!=e.ch)return!1;y=L.indexOf(v,n.ch);var E=L.slice(n.ch).lastIndexOf(C,y-n.ch);return O=-1==y||-1==E?-1:n.ch+E,(-1==y||-1==O||O==n.ch)&&(a.operation(function(){a.replaceRange("",o(c,R-(d&&L.slice(R-d.length,R)==d?d.length:0)),o(c,R+v.length));var e=x+C.length;if(d&&k.slice(e,e+d.length)==d&&(e+=d.length),a.replaceRange("",o(f,x),o(f,e)),b)for(var n=f+1;n<=c;++n){var t=a.getLine(n),i=t.indexOf(b);if(-1!=i&&!l.test(t.slice(0,i))){var r=i+b.length;d&&t.slice(r,r+d.length)==d&&(r+=d.length),a.replaceRange("",o(n,i),o(n,r))}}}),!0)})});