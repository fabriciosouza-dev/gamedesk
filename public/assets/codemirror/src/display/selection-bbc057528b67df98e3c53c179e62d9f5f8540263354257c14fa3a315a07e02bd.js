function cmpCoords(t,e){return t.top-e.top||t.left-e.left}function drawSelectionRange(t,e,o){function i(t,e,o,i){e<0&&(e=0),e=Math.round(e),i=Math.round(i),s.appendChild(elt("div",null,"CodeMirror-selected",`position: absolute; left: ${t}px;\n                             top: ${e}px; width: ${null==o?u-t:o}px;\n                             height: ${i-e}px`))}function r(e,o,r){function l(o,i){return charCoords(t,Pos(e,o),"div",h,i)}function s(e,o,i){let r=wrappedLineExtentChar(t,h,null,e),n="ltr"==o==("after"==i)?"left":"right";return l("after"==i?r.begin:r.end-(/\s/.test(h.text.charAt(r.end-1))?2:1),n)[n]}let p,c,h=getLine(n,e),f=h.text.length,m=getOrder(h,n.direction);return iterateBidiSections(m,o||0,null==r?f:r,(t,e,n,h)=>{let g="ltr"==n,y=l(t,g?"left":"right"),C=l(e-1,g?"right":"left"),b=null==o&&0==t,x=null==r&&e==f,v=0==h,w=!m||h==m.length-1;if(C.top-y.top<=3){let t=(a?x:b)&&w,e=(a?b:x)&&v?d:(g?y:C).left,o=t?u:(g?C:y).right;i(e,y.top,o-e,y.bottom)}else{let o,r,l,p;g?(o=a&&b&&v?d:y.left,r=a?u:s(t,n,"before"),l=a?d:s(e,n,"after"),p=a&&x&&w?u:C.right):(o=a?s(t,n,"before"):d,r=!a&&b&&v?u:y.right,l=!a&&x&&w?d:C.left,p=a?s(e,n,"after"):u),i(o,y.top,r-o,y.bottom),y.bottom<C.top&&i(d,y.bottom,null,C.top),i(l,C.top,p-l,C.bottom)}(!p||cmpCoords(y,p)<0)&&(p=y),cmpCoords(C,p)<0&&(p=C),(!c||cmpCoords(y,c)<0)&&(c=y),cmpCoords(C,c)<0&&(c=C)}),{start:p,end:c}}let l=t.display,n=t.doc,s=document.createDocumentFragment(),p=paddingH(t.display),d=p.left,u=Math.max(l.sizerWidth,displayWidth(t)-l.sizer.offsetLeft)-p.right,a="ltr"==n.direction,c=e.from(),h=e.to();if(c.line==h.line)r(c.line,c.ch,h.ch);else{let t=getLine(n,c.line),e=getLine(n,h.line),o=visualLine(t)==visualLine(e),l=r(c.line,c.ch,o?t.text.length+1:null).end,s=r(h.line,o?0:null,h.ch).start;o&&(l.top<s.top-2?(i(l.right,l.top,null,l.bottom),i(d,s.top,s.left,s.bottom)):i(l.right,l.top,s.left-l.right,l.bottom)),l.bottom<s.top&&i(d,l.bottom,null,s.top)}o.appendChild(s)}import{Pos}from"../line/pos.js";import{visualLine}from"../line/spans.js";import{getLine}from"../line/utils_line.js";import{charCoords,cursorCoords,displayWidth,paddingH,wrappedLineExtentChar}from"../measurement/position_measurement.js";import{getOrder,iterateBidiSections}from"../util/bidi.js";import{elt}from"../util/dom.js";import{onBlur}from"./focus.js";export function updateSelection(t){t.display.input.showSelection(t.display.input.prepareSelection())};export function prepareSelection(t,e=!0){let o=t.doc,i={},r=i.cursors=document.createDocumentFragment(),l=i.selection=document.createDocumentFragment();for(let i=0;i<o.sel.ranges.length;i++){if(!e&&i==o.sel.primIndex)continue;let n=o.sel.ranges[i];if(n.from().line>=t.display.viewTo||n.to().line<t.display.viewFrom)continue;let s=n.empty();(s||t.options.showCursorWhenSelecting)&&drawSelectionCursor(t,n.head,r),s||drawSelectionRange(t,n,l)}return i};export function drawSelectionCursor(t,e,o){let i=cursorCoords(t,e,"div",null,null,!t.options.singleCursorHeightPerLine),r=o.appendChild(elt("div","\xa0","CodeMirror-cursor"));if(r.style.left=i.left+"px",r.style.top=i.top+"px",r.style.height=Math.max(0,i.bottom-i.top)*t.options.cursorHeight+"px",i.other){let t=o.appendChild(elt("div","\xa0","CodeMirror-cursor CodeMirror-secondarycursor"));t.style.display="",t.style.left=i.other.left+"px",t.style.top=i.other.top+"px",t.style.height=.85*(i.other.bottom-i.other.top)+"px"}};export function restartBlink(t){if(!t.state.focused)return;let e=t.display;clearInterval(e.blinker);let o=!0;e.cursorDiv.style.visibility="",t.options.cursorBlinkRate>0?e.blinker=setInterval(()=>{t.hasFocus()||onBlur(t),e.cursorDiv.style.visibility=(o=!o)?"":"hidden"},t.options.cursorBlinkRate):t.options.cursorBlinkRate<0&&(e.cursorDiv.style.visibility="hidden")};