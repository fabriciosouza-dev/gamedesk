import{lst}from"./misc.js";export function iterateBidiSections(r,t,L,e){if(!r)return e(t,L,"ltr",0);let l=!1;for(let n=0;n<r.length;++n){let m=r[n];(m.from<L&&m.to>t||t==L&&m.to==t)&&(e(Math.max(m.from,t),Math.min(m.to,L),1==m.level?"rtl":"ltr",n),l=!0)}l||e(t,L,"ltr")};export let bidiOther=null;export function getBidiPartAt(r,t,L){let e;bidiOther=null;for(let l=0;l<r.length;++l){let n=r[l];if(n.from<t&&n.to>t)return l;n.to==t&&(n.from!=n.to&&"before"==L?e=l:bidiOther=l),n.from==t&&(n.from!=n.to&&"before"!=L?e=l:bidiOther=l)}return null!=e?e:bidiOther};let bidiOrdering=function(){function r(r){return r<=247?L.charAt(r):1424<=r&&r<=1524?"R":1536<=r&&r<=1785?e.charAt(r-1536):1774<=r&&r<=2220?"r":8192<=r&&r<=8203?"w":8204==r?"b":"L"}function t(r,t,L){this.level=r,this.from=t,this.to=L}let L="bbbbbbbbbtstwsbbbbbbbbbbbbbbssstwNN%%%NNNNNN,N,N1111111111NNNNNNNLLLLLLLLLLLLLLLLLLLLLLLLLLNNNNNNLLLLLLLLLLLLLLLLLLLLLLLLLLNNNNbbbbbbsbbbbbbbbbbbbbbbbbbbbbbbbbb,N%%%%NNNNLNNNNN%%11NLNNN1LNNNNNLLLLLLLLLLLLLLLLLLLLLLLNLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLN",e="nnnnnnNNr%%r,rNNmmmmmmmmmmmrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrmmmmmmmmmmmmmmmmmmmmmnnnnnnnnnn%nnrrrmrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrmmmmmmmnNmmmmmmrrmmNmmmmrr1111111111",l=/[\u0590-\u05f4\u0600-\u06ff\u0700-\u08ac]/,n=/[stwN]/,m=/[LRr]/,b=/[Lb1n]/,N=/[1n]/;return function(L,e){let o="ltr"==e?"L":"R";if(0==L.length||"ltr"==e&&!l.test(L))return!1;let f=L.length,i=[];for(let t=0;t<f;++t)i.push(r(L.charCodeAt(t)));for(let r=0,t=o;r<f;++r){let L=i[r];"m"==L?i[r]=t:t=L}for(let r=0,t=o;r<f;++r){let L=i[r];"1"==L&&"r"==t?i[r]="n":m.test(L)&&(t=L,"r"==L&&(i[r]="R"))}for(let r=1,t=i[0];r<f-1;++r){let L=i[r];"+"==L&&"1"==t&&"1"==i[r+1]?i[r]="1":","!=L||t!=i[r+1]||"1"!=t&&"n"!=t||(i[r]=t),t=L}for(let r=0;r<f;++r){let t=i[r];if(","==t)i[r]="N";else if("%"==t){let t;for(t=r+1;t<f&&"%"==i[t];++t);let L=r&&"!"==i[r-1]||t<f&&"1"==i[t]?"1":"N";for(let e=r;e<t;++e)i[e]=L;r=t-1}}for(let r=0,t=o;r<f;++r){let L=i[r];"L"==t&&"1"==L?i[r]="L":m.test(L)&&(t=L)}for(let r=0;r<f;++r)if(n.test(i[r])){let t;for(t=r+1;t<f&&n.test(i[t]);++t);let L="L"==(r?i[r-1]:o),e=L==("L"==(t<f?i[t]:o))?L?"L":"R":o;for(let L=r;L<t;++L)i[L]=e;r=t-1}let s,u=[];for(let r=0;r<f;)if(b.test(i[r])){let L=r;for(++r;r<f&&b.test(i[r]);++r);u.push(new t(0,L,r))}else{let L=r,l=u.length,n="rtl"==e?1:0;for(++r;r<f&&"L"!=i[r];++r);for(let e=L;e<r;)if(N.test(i[e])){L<e&&(u.splice(l,0,new t(1,L,e)),l+=n);let m=e;for(++e;e<r&&N.test(i[e]);++e);u.splice(l,0,new t(2,m,e)),l+=n,L=e}else++e;L<r&&u.splice(l,0,new t(1,L,r))}return"ltr"==e&&(1==u[0].level&&(s=L.match(/^\s+/))&&(u[0].from=s[0].length,u.unshift(new t(0,0,s[0].length))),1==lst(u).level&&(s=L.match(/\s+$/))&&(lst(u).to-=s[0].length,u.push(new t(0,f-s[0].length,f)))),"rtl"==e?u.reverse():u}}();export function getOrder(r,t){let L=r.order;return null==L&&(L=r.order=bidiOrdering(r.text,t)),L};