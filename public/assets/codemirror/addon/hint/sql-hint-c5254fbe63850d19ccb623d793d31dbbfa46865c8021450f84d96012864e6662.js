// CodeMirror, copyright (c) by Marijn Haverbeke and others
!function(t){"object"==typeof exports&&"object"==typeof module?t(require("../../lib/codemirror"),require("../../mode/sql/sql")):"function"==typeof define&&define.amd?define(["../../lib/codemirror","../../mode/sql/sql"],t):t(CodeMirror)}(function(t){"use strict";function e(t){return"[object Array]"==Object.prototype.toString.call(t)}function r(e){var r=e.doc.modeOption;return"sql"===r&&(r="text/x-sql"),t.resolveMode(r).keywords}function n(e){var r=e.doc.modeOption;return"sql"===r&&(r="text/x-sql"),t.resolveMode(r).identifierQuote||"`"}function o(t){return"string"==typeof t?t:t.text}function i(t,r){return e(r)&&(r={columns:r}),r.text||(r.text=t),r}function s(t){var r={};if(e(t))for(var n=t.length-1;n>=0;n--){var s=t[n];r[o(s).toUpperCase()]=i(o(s),s)}else if(t)for(var a in t)r[a.toUpperCase()]=i(a,t[a]);return r}function a(t){return v[t.toUpperCase()]}function u(t){var e={};for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);return e}function l(t,e){var r=t.length,n=o(e).substr(0,r);return t.toUpperCase()===n.toUpperCase()}function f(t,r,n,o){if(e(n))for(var i=0;i<n.length;i++)l(r,n[i])&&t.push(o(n[i]));else for(var s in n)if(n.hasOwnProperty(s)){var a=n[s];l(r,a=a&&!0!==a?a.displayText?{text:a.text,displayText:a.displayText}:a.text:s)&&t.push(o(a))}}function c(t){"."==t.charAt(0)&&(t=t.substr(1));for(var e=t.split(b+b),r=0;r<e.length;r++)e[r]=e[r].replace(new RegExp(b,"g"),"");return e.join(b)}function p(t){for(var e=o(t).split("."),r=0;r<e.length;r++)e[r]=b+e[r].replace(new RegExp(b,"g"),b+b)+b;var n=e.join(".");return"string"==typeof t?n:((t=u(t)).text=n,t)}function d(t,e,r,n){for(var o=!1,i=[],s=e.start,l=!0;l;)l="."==e.string.charAt(0),o=o||e.string.charAt(0)==b,s=e.start,i.unshift(c(e.string)),"."==(e=n.getTokenAt(C(t.line,e.start))).string&&(l=!0,e=n.getTokenAt(C(t.line,e.start)));var d=i.join(".");f(r,d,v,function(t){return o?p(t):t}),f(r,d,x,function(t){return o?p(t):t}),d=i.pop();var g=i.join("."),m=!1,y=g;if(!a(g)){var A=g;(g=h(g,n))!==A&&(m=!0)}var q=a(g);return q&&q.columns&&(q=q.columns),q&&f(r,d,q,function(t){var e=g;return 1==m&&(e=y),"string"==typeof t?t=e+"."+t:(t=u(t)).text=e+"."+t.text,o?p(t):t}),s}function g(t,e){for(var r=t.split(/\s+/),n=0;n<r.length;n++)r[n]&&e(r[n].replace(/[`,;]/g,""))}function h(t,e){for(var r=e.doc,n=r.getValue(),o=t.toUpperCase(),i="",s="",u=[],l={start:C(0,0),end:C(e.lastLine(),e.getLineHandle(e.lastLine()).length)},f=n.indexOf(y.QUERY_DIV);-1!=f;)u.push(r.posFromIndex(f)),f=n.indexOf(y.QUERY_DIV,f+1);u.unshift(C(0,0)),u.push(C(e.lastLine(),e.getLineHandle(e.lastLine()).text.length));for(var c=null,p=e.getCursor(),d=0;d<u.length;d++){if((null==c||A(p,c)>0)&&A(p,u[d])<=0){l={start:c,end:u[d]};break}c=u[d]}if(l.start){var h=r.getRange(l.start,l.end,!1);for(d=0;d<h.length;d++){if(g(h[d],function(t){var e=t.toUpperCase();e===o&&a(i)&&(s=i),e!==y.ALIAS_KEYWORD&&(i=t)}),s)break}}return s}var v,x,m,b,y={QUERY_DIV:";",ALIAS_KEYWORD:"AS"},C=t.Pos,A=t.cmpPos;t.registerHelper("hint","sql",function(t,e){v=s(e&&e.tables);var o=e&&e.defaultTable,i=e&&e.disableKeywords;x=o&&a(o),m=r(t),b=n(t),o&&!x&&(x=h(o,t)),(x=x||[]).columns&&(x=x.columns);var u,l,c,p=t.getCursor(),g=[],y=t.getTokenAt(p);if(y.end>p.ch&&(y.end=p.ch,y.string=y.string.slice(0,p.ch-y.start)),y.string.match(/^[.`"'\w@][\w$#]*$/g)?(c=y.string,u=y.start,l=y.end):(u=l=p.ch,c=""),"."==c.charAt(0)||c.charAt(0)==b)u=d(p,y,g,t);else{var A=function(t,e){return"object"==typeof t?t.className=e:t={text:t,className:e},t};f(g,c,x,function(t){return A(t,"CodeMirror-hint-table CodeMirror-hint-default-table")}),f(g,c,v,function(t){return A(t,"CodeMirror-hint-table")}),i||f(g,c,m,function(t){return A(t.toUpperCase(),"CodeMirror-hint-keyword")})}return{list:g,from:C(p.line,u),to:C(p.line,l)}})});