// CodeMirror, copyright (c) by Marijn Haverbeke and others
!function(t){"object"==typeof exports&&"object"==typeof module?t(require("../../lib/codemirror")):"function"==typeof define&&define.amd?define(["../../lib/codemirror"],t):t(CodeMirror)}(function(t){"use strict";function e(t,e,r){return r?t.indexOf(e)>=0:0==t.lastIndexOf(e,0)}function r(r,i){function s(){return{list:u,from:d?n(f.line,null==h?g.start:h):f,to:d?n(f.line,g.end):f}}var a=i&&i.schemaInfo,o=i&&i.quoteChar||'"',l=i&&i.matchInMiddle;if(a){var f=r.getCursor(),g=r.getTokenAt(f);g.end>f.ch&&(g.end=f.ch,g.string=g.string.slice(0,f.ch-g.start));if((C=t.innerMode(r.getMode(),g.state)).mode.xmlCurrentTag){var c,h,u=[],d=!1,p=/\btag\b/.test(g.type)&&!/>$/.test(g.string),m=p&&/^\w/.test(g.string);if(m){var v=r.getLine(f.line).slice(Math.max(0,g.start-2),g.start),y=/<\/$/.test(v)?"close":/<$/.test(v)?"open":null;y&&(h=g.start-("close"==y?2:1))}else p&&"<"==g.string?y="open":p&&"</"==g.string&&(y="close");var x=C.mode.xmlCurrentTag(C.state);if(!p&&!x||y){m&&(c=g.string),d=y;var C,b=C.mode.xmlCurrentContext?C.mode.xmlCurrentContext(C.state):[],O=(C=b.length&&b[b.length-1])&&a[C],w=C?O&&O.children:a["!top"];if(w&&"close"!=y)for(var A=0;A<w.length;++A)c&&!e(w[A],c,l)||u.push("<"+w[A]);else if("close"!=y)for(var M in a)!a.hasOwnProperty(M)||"!top"==M||"!attrs"==M||c&&!e(M,c,l)||u.push("<"+M);C&&(!c||"close"==y&&e(C,c,l))&&u.push("</"+C+">")}else{var P=(O=x&&a[x.name])&&O.attrs,$=a["!attrs"];if(!P&&!$)return;if(P){if($){var I={};for(var T in $)$.hasOwnProperty(T)&&(I[T]=$[T]);for(var T in P)P.hasOwnProperty(T)&&(I[T]=P[T]);P=I}}else P=$;if("string"==g.type||"="==g.string){var j,q=(v=r.getRange(n(f.line,Math.max(0,f.ch-60)),n(f.line,"string"==g.type?g.start:g.end))).match(/([^\s\u00a0=<>\"\']+)=$/);if(!q||!P.hasOwnProperty(q[1])||!(j=P[q[1]]))return;if("function"==typeof j&&(j=j.call(this,r)),"string"==g.type){c=g.string;var L=0;/['"]/.test(g.string.charAt(0))&&(o=g.string.charAt(0),c=g.string.slice(1),L++);var k=g.string.length;if(/['"]/.test(g.string.charAt(k-1))&&(o=g.string.charAt(k-1),c=g.string.substr(L,k-2)),L){var H=r.getLine(f.line);H.length>g.end&&H.charAt(g.end)==o&&g.end++}d=!0}var R=function(t){if(t)for(var r=0;r<t.length;++r)c&&!e(t[r],c,l)||u.push(o+t[r]+o);return s()};return j&&j.then?j.then(R):R(j)}"attribute"==g.type&&(c=g.string,d=!0);for(var z in P)!P.hasOwnProperty(z)||c&&!e(z,c,l)||u.push(z)}return s()}}}var n=t.Pos;t.registerHelper("hint","xml",r)});