// CodeMirror, copyright (c) by Marijn Haverbeke and others
!function(t){"object"==typeof exports&&"object"==typeof module?t(require("../../lib/codemirror"),require("./foldcode")):"function"==typeof define&&define.amd?define(["../../lib/codemirror","./foldcode"],t):t(CodeMirror)}(function(t){"use strict";function o(t){this.options=t,this.from=this.to=0}function e(t){return!0===t&&(t={}),null==t.gutter&&(t.gutter="CodeMirror-foldgutter"),null==t.indicatorOpen&&(t.indicatorOpen="CodeMirror-foldgutter-open"),null==t.indicatorFolded&&(t.indicatorFolded="CodeMirror-foldgutter-folded"),t}function r(t,o){for(var e=t.findMarks(s(o,0),s(o+1,0)),r=0;r<e.length;++r)if(e[r].__isFold){var n=e[r].find(-1);if(n&&n.line===o)return e[r]}}function n(t){if("string"==typeof t){var o=document.createElement("div");return o.className=t+" CodeMirror-guttermarker-subtle",o}return t.cloneNode(!0)}function i(t,o,e){var i=t.state.foldGutter.options,a=o-1,d=t.foldOption(i,"minFoldSize"),u=t.foldOption(i,"rangeFinder"),l="string"==typeof i.indicatorFolded&&f(i.indicatorFolded),c="string"==typeof i.indicatorOpen&&f(i.indicatorOpen);t.eachLine(o,e,function(o){++a;var e=null,f=o.gutterMarkers;if(f&&(f=f[i.gutter]),r(t,a)){if(l&&f&&l.test(f.className))return;e=n(i.indicatorFolded)}else{var p=s(a,0),m=u&&u(t,p);if(m&&m.to.line-m.from.line>=d){if(c&&f&&c.test(f.className))return;e=n(i.indicatorOpen)}}(e||f)&&t.setGutterMarker(o,i.gutter,e)})}function f(t){return new RegExp("(^|\\s)"+t+"(?:$|\\s)\\s*")}function a(t){var o=t.getViewport(),e=t.state.foldGutter;e&&(t.operation(function(){i(t,o.from,o.to)}),e.from=o.from,e.to=o.to)}function d(t,o,e){var n=t.state.foldGutter;if(n){var i=n.options;if(e==i.gutter){var f=r(t,o);f?f.clear():t.foldCode(s(o,0),i)}}}function u(t){var o=t.state.foldGutter;if(o){var e=o.options;o.from=o.to=0,clearTimeout(o.changeUpdate),o.changeUpdate=setTimeout(function(){a(t)},e.foldOnChangeTimeSpan||600)}}function l(t){var o=t.state.foldGutter;if(o){var e=o.options;clearTimeout(o.changeUpdate),o.changeUpdate=setTimeout(function(){var e=t.getViewport();o.from==o.to||e.from-o.to>20||o.from-e.to>20?a(t):t.operation(function(){e.from<o.from&&(i(t,e.from,o.from),o.from=e.from),e.to>o.to&&(i(t,o.to,e.to),o.to=e.to)})},e.updateViewportTimeSpan||400)}}function c(t,o){var e=t.state.foldGutter;if(e){var r=o.line;r>=e.from&&r<e.to&&i(t,r,r+1)}}t.defineOption("foldGutter",!1,function(r,n,i){i&&i!=t.Init&&(r.clearGutter(r.state.foldGutter.options.gutter),r.state.foldGutter=null,r.off("gutterClick",d),r.off("changes",u),r.off("viewportChange",l),r.off("fold",c),r.off("unfold",c),r.off("swapDoc",u)),n&&(r.state.foldGutter=new o(e(n)),a(r),r.on("gutterClick",d),r.on("changes",u),r.on("viewportChange",l),r.on("fold",c),r.on("unfold",c),r.on("swapDoc",u))});var s=t.Pos});