// CodeMirror, copyright (c) by Marijn Haverbeke and others
!function(t){"object"==typeof exports&&"object"==typeof module?t(require("../../lib/codemirror")):"function"==typeof define&&define.amd?define(["../../lib/codemirror"],t):t(CodeMirror)}(function(t){"use strict";function e(t,e,n){var o=t.docs[e];o?n(F(t,o)):t.options.getFile?t.options.getFile(e,n):n(null)}function n(t,e,n){for(var o in t.docs){var i=t.docs[o];if(i.doc==e)return i}if(!n)for(var r=0;;++r)if(o="[doc"+(r||"")+"]",!t.docs[o]){n=o;break}return t.addDoc(n,e)}function o(e,o){return"string"==typeof o?e.docs[o]:(o instanceof t&&(o=o.getDoc()),o instanceof t.Doc?n(e,o):void 0)}function i(t,e,o){var i=n(t,e),s=t.cachedArgHints;s&&s.doc==e&&B(s.start,o.to)>=0&&(t.cachedArgHints=null);var a=i.changed;null==a&&(i.changed=a={from:o.from.line,to:o.from.line});var c=o.from.line+(o.text.length-1);o.from.line<a.to&&(a.to=a.to-(o.to.line-c)),c>=a.to&&(a.to=c+1),a.from>o.from.line&&(a.from=o.from.line),e.lineCount()>O&&o.to-a.from>100&&setTimeout(function(){i.changed&&i.changed.to-i.changed.from>100&&r(t,i)},200)}function r(t,e){t.server.request({files:[{type:"full",name:e.name,text:F(t,e)}]},function(t){t?window.console.error(t):e.changed=null})}function s(e,n,o){e.request(n,{type:"completions",types:!0,docs:!0,urls:!0},function(i,r){if(i)return N(e,n,i);var s=[],c="",l=r.start,u=r.end;'["'==n.getRange(j(l.line,l.ch-2),l)&&'"]'!=n.getRange(u,j(u.line,u.ch+2))&&(c='"]');for(var f=0;f<r.completions.length;++f){var d=r.completions[f],p=a(d.type);r.guess&&(p+=" "+L+"guess"),s.push({text:d.name+c,displayText:d.displayName||d.name,className:p,data:d})}var h={from:l,to:u,list:s},g=null;t.on(h,"close",function(){H(g)}),t.on(h,"update",function(){H(g)}),t.on(h,"select",function(t,o){H(g);var i=e.options.completionTip?e.options.completionTip(t.data):t.data.doc;i&&(g=A(o.parentNode.getBoundingClientRect().right+window.pageXOffset,o.getBoundingClientRect().top+window.pageYOffset,i,n,L+"hint-doc"))}),o(h)})}function a(t){var e;return e="?"==t?"unknown":"number"==t||"string"==t||"bool"==t?t:/^fn\(/.test(t)?"fn":/^\[/.test(t)?"array":"object",L+"completion "+L+"completion-"+e}function c(t,e,n,o,i){t.request(e,o,function(n,o){if(n)return N(t,e,n);if(t.options.typeTip)var r=t.options.typeTip(o);else{r=b("span",null,b("strong",null,o.type||"not found"));if(o.doc&&r.appendChild(document.createTextNode(" \u2014 "+o.doc)),o.url){r.appendChild(document.createTextNode(" "));var s=r.appendChild(b("a",null,"[docs]"));s.href=o.url,s.target="_blank"}}k(e,r,t),i&&i()},n)}function l(e,n){if(S(e),!n.somethingSelected()){var o=n.getTokenAt(n.getCursor()).state,i=t.innerMode(n.getMode(),o);if("javascript"==i.mode.name){var r=i.state.lexical;if("call"==r.info){for(var s,a=r.pos||0,c=n.getOption("tabSize"),l=n.getCursor().line,d=Math.max(0,l-9),p=!1;l>=d;--l){for(var h=n.getLine(l),g=0,m=0;;){var v=h.indexOf("\t",m);if(-1==v)break;g+=c-(v+g)%c-1,m=v+1}if(s=r.column-g,"("==h.charAt(s)){p=!0;break}}if(p){var y=j(l,s),C=e.cachedArgHints;if(C&&C.doc==n.getDoc()&&0==B(y,C.start))return u(e,n,a);e.request(n,{type:"type",preferFunction:!0,end:y},function(t,o){!t&&o.type&&/^fn\(/.test(o.type)&&(e.cachedArgHints={start:y,type:f(o.type),name:o.exprName||o.name||"fn",guess:o.guess,doc:n.getDoc()},u(e,n,a))})}}}}}function u(t,e,n){S(t);for(var o=t.cachedArgHints,i=o.type,r=b("span",o.guess?L+"fhint-guess":null,b("span",L+"fname",o.name),"("),s=0;s<i.args.length;++s){s&&r.appendChild(document.createTextNode(", "));var a=i.args[s];r.appendChild(b("span",L+"farg"+(s==n?" "+L+"farg-current":""),a.name||"?")),"?"!=a.type&&(r.appendChild(document.createTextNode(":\xa0")),r.appendChild(b("span",L+"type",a.type)))}r.appendChild(document.createTextNode(i.rettype?") ->\xa0":")")),i.rettype&&r.appendChild(b("span",L+"type",i.rettype));var c=e.cursorCoords(null,"page"),l=t.activeArgHints=A(c.right+1,c.bottom,r,e);setTimeout(function(){l.clear=D(e,function(){t.activeArgHints==l&&S(t)})},20)}function f(t){function e(e){for(var n=0,i=o;;){var r=t.charAt(o);if(e.test(r)&&!n)return t.slice(i,o);/[{\[\(]/.test(r)?++n:/[}\]\)]/.test(r)&&--n,++o}}var n=[],o=3;if(")"!=t.charAt(o))for(;;){var i=t.slice(o).match(/^([^, \(\[\{]+): /);if(i&&(o+=i[0].length,i=i[1]),n.push({name:i,type:e(/[\),]/)}),")"==t.charAt(o))break;o+=2}var r=t.slice(o).match(/^\) -> (.*)$/);return{args:n,rettype:r&&r[1]}}function d(t,e){function o(o){var i={type:"definition",variable:o||null},r=n(t,e.getDoc());t.server.request(x(t,r,i),function(n,o){if(n)return N(t,e,n);if(o.file||!o.url){if(o.file){var i,s=t.docs[o.file];if(s&&(i=g(s.doc,o)))return t.jumpStack.push({file:r.name,start:e.getCursor("from"),end:e.getCursor("to")}),void h(t,r,s,i.start,i.end)}N(t,e,"Could not find a definition.")}else window.open(o.url)})}m(e)?o():T(e,"Jump to variable",function(t){t&&o(t)})}function p(t,e){var o=t.jumpStack.pop(),i=o&&t.docs[o.file];i&&h(t,n(t,e.getDoc()),i,o.start,o.end)}function h(t,e,n,o,i){n.doc.setSelection(o,i),e!=n&&t.options.switchToDoc&&(S(t),t.options.switchToDoc(n.name,n.doc))}function g(t,e){for(var n=e.context.slice(0,e.contextOffset).split("\n"),o=e.start.line-(n.length-1),i=j(o,(1==n.length?e.start.ch:t.getLine(o).length)-n[0].length),r=t.getLine(o).slice(i.ch),s=o+1;s<t.lineCount()&&r.length<e.context.length;++s)r+="\n"+t.getLine(s);if(r.slice(0,e.context.length)==e.context)return e;for(var a,c=t.getSearchCursor(e.context,0,!1),l=Infinity;c.findNext();){var u=c.from(),f=1e4*Math.abs(u.line-i.line);f||(f=Math.abs(u.ch-i.ch)),f<l&&(a=u,l=f)}if(!a)return null;if(1==n.length?a.ch+=n[0].length:a=j(a.line+(n.length-1),n[n.length-1].length),e.start.line==e.end.line)var d=j(a.line,a.ch+(e.end.ch-e.start.ch));else d=j(a.line+(e.end.line-e.start.line),e.end.ch);return{start:a,end:d}}function m(t){var e=t.getCursor("end"),n=t.getTokenAt(e);return!(n.start<e.ch&&"comment"==n.type)&&/[\w)\]]/.test(t.getLine(e.line).slice(Math.max(e.ch-1,0),e.ch+1))}function v(t,e){var n=e.getTokenAt(e.getCursor());if(!/\w/.test(n.string))return N(t,e,"Not at a variable");T(e,"New name for "+n.string,function(n){t.request(e,{type:"rename",newName:n,fullDocs:!0},function(n,o){if(n)return N(t,e,n);C(t,o.changes)})})}function y(t,e){var o=n(t,e.doc).name;t.request(e,{type:"refs"},function(n,i){if(n)return N(t,e,n);for(var r=[],s=0,a=e.getCursor(),c=0;c<i.refs.length;c++){var l=i.refs[c];l.file==o&&(r.push({anchor:l.start,head:l.end}),B(a,l.start)>=0&&B(a,l.end)<=0&&(s=r.length-1))}e.setSelections(r,s)})}function C(t,e){for(var n=Object.create(null),o=0;o<e.length;++o){(n[(c=e[o]).file]||(n[c.file]=[])).push(c)}for(var i in n){var r=t.docs[i],s=n[i];if(r){s.sort(function(t,e){return B(e.start,t.start)});var a="*rename"+ ++R;for(o=0;o<s.length;++o){var c=s[o];r.doc.replaceRange(c.text,c.start,c.end,a)}}}}function x(t,e,n,o){var i=[],r=0,s=!n.fullDocs;s||delete n.fullDocs,"string"==typeof n&&(n={type:n}),n.lineCharPositions=!0,null==n.end&&(n.end=o||e.doc.getCursor("end"),e.doc.somethingSelected()&&(n.start=e.doc.getCursor("start")));var a=n.start||n.end;if(e.changed)if(e.doc.lineCount()>O&&!1!==s&&e.changed.to-e.changed.from<100&&e.changed.from<=a.line&&e.changed.to>n.end.line){i.push(w(e,a,n.end)),n.file="#0";r=i[0].offsetLines;null!=n.start&&(n.start=j(n.start.line- -r,n.start.ch)),n.end=j(n.end.line-r,n.end.ch)}else i.push({type:"full",name:e.name,text:F(t,e)}),n.file=e.name,e.changed=null;else n.file=e.name;for(var c in t.docs){var l=t.docs[c];l.changed&&l!=e&&(i.push({type:"full",name:l.name,text:F(t,l)}),l.changed=null)}return{query:n,files:i}}function w(e,n,o){for(var i,r=e.doc,s=null,a=null,c=4,l=n.line-1,u=Math.max(0,l-50);l>=u;--l){var f=r.getLine(l);if(!(f.search(/\bfunction\b/)<0)){var d=t.countColumn(f,null,c);null!=s&&s<=d||(s=d,a=l)}}null==a&&(a=u);var p=Math.min(r.lastLine(),o.line+20);if(null==s||s==t.countColumn(r.getLine(n.line),null,c))i=p;else for(i=o.line+1;i<p;++i){if((d=t.countColumn(r.getLine(i),null,c))<=s)break}var h=j(a,0);return{type:"part",name:e.name,offsetLines:h.line,text:r.getRange(h,j(i,o.line==i?null:0))}}function b(t,e){var n=document.createElement(t);e&&(n.className=e);for(var o=2;o<arguments.length;++o){var i=arguments[o];"string"==typeof i&&(i=document.createTextNode(i)),n.appendChild(i)}return n}function T(t,e,n){t.openDialog?t.openDialog(e+": <input type=text>",n):n(prompt(e,""))}function k(e,n,o){function i(){l=!0,c||r()}function r(){e.state.ternTooltip=null,a.parentNode&&q(a),u()}e.state.ternTooltip&&H(e.state.ternTooltip);var s=e.cursorCoords(),a=e.state.ternTooltip=A(s.right+1,s.bottom,n,e),c=!1,l=!1;t.on(a,"mousemove",function(){c=!0}),t.on(a,"mouseout",function(e){var n=e.relatedTarget||e.toElement;n&&t.contains(a,n)||(l?r():c=!1)}),setTimeout(i,o.options.hintDelay?o.options.hintDelay:1700);var u=D(e,r)}function D(t,e){return t.on("cursorActivity",e),t.on("blur",e),t.on("scroll",e),t.on("setDoc",e),function(){t.off("cursorActivity",e),t.off("blur",e),t.off("scroll",e),t.off("setDoc",e)}}function A(t,e,n,o,i){var r=b("div",L+"tooltip "+(i||""),n);r.style.left=t+"px",r.style.top=e+"px";(((o.options||{}).hintOptions||{}).container||document.body).appendChild(r);var s=o.cursorCoords(),a=window.innerWidth,c=window.innerHeight,l=r.getBoundingClientRect(),u=document.querySelector(".CodeMirror-hints"),f=l.bottom-c,d=l.right-a;if(u&&d>0){r.style.left=0;l=r.getBoundingClientRect();r.style.left=(t=t-u.offsetWidth-l.width)+"px",d=l.right-a}if(f>0){var p=l.bottom-l.top;s.top-(s.bottom-l.top)-p>0?r.style.top=s.top-p+"px":p>c&&(r.style.height=c-5+"px",r.style.top=s.bottom-l.top+"px")}return d>0&&(l.right-l.left>a&&(r.style.width=a-5+"px",d-=l.right-l.left-a),r.style.left=t-d+"px"),r}function H(t){var e=t&&t.parentNode;e&&e.removeChild(t)}function q(t){t.style.opacity="0",setTimeout(function(){H(t)},1100)}function N(t,e,n){t.options.showError?t.options.showError(e,n):k(e,String(n),t)}function S(t){t.activeArgHints&&(t.activeArgHints.clear&&t.activeArgHints.clear(),H(t.activeArgHints),t.activeArgHints=null)}function F(t,e){var n=e.doc.getValue();return t.options.fileFilter&&(n=t.options.fileFilter(n,e.name,e.doc)),n}function M(t){function n(t,e){e&&(t.id=++i,r[i]=e),o.postMessage(t)}var o=t.worker=new Worker(t.options.workerScript);o.postMessage({type:"init",defs:t.options.defs,plugins:t.options.plugins,scripts:t.options.workerDeps});var i=0,r={};o.onmessage=function(o){var i=o.data;"getFile"==i.type?e(t,i.name,function(t,e){n({type:"getFile",err:String(t),text:e,id:i.id})}):"debug"==i.type?window.console.log(i.message):i.id&&r[i.id]&&(r[i.id](i.err,i.body),delete r[i.id])},o.onerror=function(t){for(var e in r)r[e](t);r={}},this.addFile=function(t,e){n({type:"add",name:t,text:e})},this.delFile=function(t){n({type:"del",name:t})},this.request=function(t,e){n({type:"req",body:t},e)}}t.TernServer=function(t){var n=this;this.options=t||{};var o=this.options.plugins||(this.options.plugins={});o.doc_comment||(o.doc_comment=!0),this.docs=Object.create(null),this.options.useWorker?this.server=new M(this):this.server=new tern.Server({getFile:function(t,o){return e(n,t,o)},async:!0,defs:this.options.defs||[],plugins:o}),this.trackChange=function(t,e){i(n,t,e)},this.cachedArgHints=null,this.activeArgHints=null,this.jumpStack=[],this.getHint=function(t,e){return s(n,t,e)},this.getHint.async=!0},t.TernServer.prototype={addDoc:function(e,n){var o={doc:n,name:e,changed:null};return this.server.addFile(e,F(this,o)),t.on(n,"change",this.trackChange),this.docs[e]=o},delDoc:function(e){var n=o(this,e);n&&(t.off(n.doc,"change",this.trackChange),delete this.docs[n.name],this.server.delFile(n.name))},hideDoc:function(t){S(this);var e=o(this,t);e&&e.changed&&r(this,e)},complete:function(t){t.showHint({hint:this.getHint})},showType:function(t,e,n){c(this,t,e,"type",n)},showDocs:function(t,e,n){c(this,t,e,"documentation",n)},updateArgHints:function(t){l(this,t)},jumpToDef:function(t){d(this,t)},jumpBack:function(t){p(this,t)},rename:function(t){v(this,t)},selectName:function(t){y(this,t)},request:function(t,e,o,i){var r=this,s=n(this,t.getDoc()),a=x(this,s,e,i),c=a.query&&this.options.queryOptions&&this.options.queryOptions[a.query.type];if(c)for(var l in c)a.query[l]=c[l];this.server.request(a,function(t,n){!t&&r.options.responseFilter&&(n=r.options.responseFilter(s,e,a,t,n)),o(t,n)})},destroy:function(){S(this),this.worker&&(this.worker.terminate(),this.worker=null)}};var j=t.Pos,L="CodeMirror-Tern-",O=250,R=0,B=t.cmpPos});